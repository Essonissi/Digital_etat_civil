{% extends 'layouts/base_admin.html' %}
{% load static %}

{% block title %}Ajouter un centre d'intérêt{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la page -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-compass text-primary me-3"></i>
                    {% if is_edit %}Modifier le centre d'intérêt{% else %}Ajouter un centre d'intérêt{% endif %}
                </h1>
                <p class="page-subtitle text-muted mb-0">
                    {% if is_edit %}Modifiez les informations du centre d'intérêt{% else %}Créez un nouveau centre d'intérêt avec sa localisation géographique{% endif %}
                </p>
            </div>
            <div class="page-actions">
                
            </div>
        </div>
    </div>

    <!-- Formulaire principal -->
    <div class="row g-4">
        <!-- Colonne formulaire -->
        <div class="col-lg-8">
            <div class="card modern-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit text-primary me-2"></i>
                        {% if is_edit %}Modifier les informations{% else %}Informations du centre{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="centerForm">
                        {% csrf_token %}

                        <div class="row g-3">
                            <!-- Nom du centre -->
                            <div class="col-md-6">
                                <label for="{{ form.nom.id_for_label }}" class="form-label required">
                                    <i class="fas fa-building me-1"></i>Nom du centre
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-building text-muted"></i>
                                    </span>
                                    {{ form.nom }}
                                </div>
                                <div class="form-text">Nom officiel du centre d'intérêt</div>
                            </div>

                            <!-- Type de centre -->
                            <div class="col-md-6">
                                <label for="{{ form.type.id_for_label }}" class="form-label required">
                                    <i class="fas fa-tags me-1"></i>Type de centre
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-tags text-muted"></i>
                                    </span>
                                    {{ form.type }}
                                </div>
                                <div class="form-text">Catégorie du centre d'intérêt</div>
                            </div>

                            <!-- Quartier -->
                            <div class="col-md-12">
                                <label for="id_quartier" class="form-label required">
                                    <i class="fas fa-map-marker-alt me-1"></i>Quartier
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map-marker-alt text-muted"></i>
                                    </span>
                                    <select name="quartier" id="id_quartier" class="form-select" required>
                                        <option value="">-- Sélectionner un quartier --</option>
                                        {% for q in quartiers %}
                                            <option value="{{ q.id }}" {% if is_edit and q.id == centre.quartier.id %}selected{% endif %}>{{ q.nom }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-text">Sélectionnez le quartier où se trouve le centre</div>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    <i class="fas fa-file-alt me-1"></i>Description
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text align-self-start">
                                        <i class="fas fa-file-alt text-muted"></i>
                                    </span>
                                    {{ form.description }}
                                </div>
                                <div class="form-text">Description détaillée du centre d'intérêt</div>
                            </div>
                        </div>

                        <!-- Coordonnées cachées -->
                        {{ form.latitude }}
                        {{ form.longitude }}

                        <!-- Actions -->
                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                <i class="fas fa-times me-2"></i>Annuler
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Modifier le centre{% else %}Ajouter le centre{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Colonne carte -->
        <div class="col-lg-4">
            <div class="card modern-card sticky-top">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map text-success me-2"></i>
                        Localisation
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" class="map-container"></div>
                    <div class="p-3">
                        <div class="coordinates-info">
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-crosshairs me-1"></i>Coordonnées sélectionnées :
                            </small>
                            <div class="coordinate-display">
                                <span class="badge bg-primary" id="coordDisplay">
                                    Cliquez sur la carte
                                </span>
                            </div>
                        </div>
                        <div class="map-instructions mt-3">
                            <div class="alert alert-info py-2 px-3 mb-0">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Cliquez sur la carte pour définir la position exacte du centre d'intérêt
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles personnalisés -->
<style>
    .page-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: #6c757d;
    }

    .modern-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

    .modern-card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .card-header {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-bottom: 1px solid #e9ecef;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
    }

    .card-title {
        font-weight: 600;
        color: #2c3e50;
    }

    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.75rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .input-group-text {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px 0 0 8px;
    }

    .input-group .form-control,
    .input-group .form-select {
        border-radius: 0 8px 8px 0;
    }

    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    .map-container {
        height: 350px;
        border-radius: 0;
        position: relative;
    }

    .coordinate-display {
        font-family: 'Courier New', monospace;
    }

    .coordinates-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid #e9ecef;
    }

    .sticky-top {
        top: 100px !important;
    }

    .btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
        border: none;
        box-shadow: 0 2px 10px rgba(13, 110, 253, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
    }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background: #6c757d;
        border-color: #6c757d;
        transform: translateY(-1px);
    }

    .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        border: 1px solid #b8daff;
        color: #0c5460;
        border-radius: 8px;
    }

    /* Animation d'entrée */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modern-card {
        animation: slideInUp 0.6s ease;
    }

    .col-lg-4 .modern-card {
        animation-delay: 0.2s;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .sticky-top {
            position: relative !important;
            top: auto !important;
        }
        
        .page-header {
            padding: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
        }
    }
</style>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialisation de la carte
        const map = L.map('map').setView([6.1319, 1.2228], 13); // Lomé, Togo

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        let marker;
        const coordDisplay = document.getElementById('coordDisplay');
        const submitBtn = document.getElementById('submitBtn');

        // Icône personnalisée pour le marqueur
        const customIcon = L.divIcon({
            html: '<i class="fas fa-map-marker-alt text-danger fa-2x"></i>',
            iconSize: [30, 30],
            className: 'custom-div-icon'
        });

        function onMapClick(e) {
            const lat = parseFloat(e.latlng.lat).toFixed(6);
            const lng = parseFloat(e.latlng.lng).toFixed(6);
    
    // Conversion en float avant enregistrement
    
    
   
}

            // Mise à jour du marqueur
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng, {icon: customIcon}).addTo(map);
            }

            // Mise à jour des champs cachés
            document.getElementById('id_latitude').value = parseFloat(lat);
            document.getElementById('id_longitude').value = parseFloat(lng);

            // Mise à jour de l'affichage des coordonnées
            coordDisplay.innerHTML = `<i class="fas fa-map-marker-alt me-1"></i>${lat}, ${lng}`;
            coordDisplay.className = 'badge bg-success';

            // Animation du bouton submit
            submitBtn.classList.add('btn-pulse');
            setTimeout(() => submitBtn.classList.remove('btn-pulse'), 1000);
        }

        map.on('click', onMapClick);

        // Animation du bouton
        const style = document.createElement('style');
        style.textContent = `
            .btn-pulse {
                animation: pulse 0.5s ease-in-out;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .custom-div-icon {
                background: transparent;
                border: none;
            }
            
            .leaflet-div-icon {
                background: transparent;
                border: none;
            }
        `;
        document.head.appendChild(style);

        // Gérer les coordonnées existantes en cas de modification
        {% if is_edit and centre.latitude is not None and centre.longitude is not None %}
            const existingLat = {{ existing_lat|floatformat:"6" }};
            const existingLng = {{ existing_lng|floatformat:"6" }};
            
            // Centrer la carte sur les coordonnées existantes
            map.setView([existingLat, existingLng], 15);
            
            // Ajouter le marqueur existant
            marker = L.marker([existingLat, existingLng], {icon: customIcon}).addTo(map);
            
            // Mettre à jour l'affichage
            coordDisplay.innerHTML = `<i class="fas fa-map-marker-alt me-1"></i>${existingLat.toFixed(6)}, ${existingLng.toFixed(6)}`;
            coordDisplay.className = 'badge bg-success';
            
            // Pré-remplir les champs cachés
            document.getElementById('id_latitude').value = existingLat;
            document.getElementById('id_longitude').value = existingLng;
        {% endif %}

        // Validation du formulaire
        document.getElementById('centerForm').addEventListener('submit', function(e) {
            const lat = document.getElementById('id_latitude').value;
            const lng = document.getElementById('id_longitude').value;
            
            if (!lat || !lng) {
                e.preventDefault();
                alert('Veuillez sélectionner une position sur la carte');
                return false;
            }
            
            // Animation de soumission
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% if is_edit %}Modification...{% else %}Enregistrement...{% endif %}';
            submitBtn.disabled = true;
        });

        // Amélioration de l'expérience utilisateur
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.closest('.input-group')?.style.setProperty('transform', 'translateY(-2px)');
            });
            
            input.addEventListener('blur', function() {
                this.closest('.input-group')?.style.setProperty('transform', 'translateY(0)');
            });
        });
    });
</script>
{% endblock %}